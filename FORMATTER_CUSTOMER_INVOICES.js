// n8n Code Node - Customer Invoices Formatter with Contextual Suggestions
// р╣Гр╕Кр╣Йр╕лр╕ер╕▒р╕З Execute SQL Query node р╕кр╕│р╕лр╕гр╕▒р╕Ъ customer_invoices action
// р╕зр╕▓р╕Зр╣Вр╕Др╣Йр╕Фр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Щр╕╡р╣Йр╣Гр╕Щ Code In JavaScript node

// р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕гр╕╖р╕нр╣Др╕бр╣И
const items = $input.all();

// ============================================
// р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 1: р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕ер╕в
// ============================================
if (!items || items.length === 0) {
  return {
    json: {
      reply: "р╕Вр╕нр╕нр╕ар╕▒р╕вр╕Др╕гр╕▒р╕Ъ р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Щр╕╡р╣Й ЁЯШФ\n\n" +
             "ЁЯФН р╕кр╕▓р╣Ар╕лр╕Хр╕╕р╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╣Др╕Ыр╣Др╕Фр╣Й:\n" +
             "  тАв р╕Кр╕╖р╣Ир╕нр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З р╕лр╕гр╕╖р╕нр╕кр╕░р╕Бр╕Фр╕Ьр╕┤р╕Ф\n" +
             "  тАв р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Щр╕╡р╣Йр╕вр╕▒р╕Зр╣Др╕бр╣Ир╕бр╕╡ invoice\n\n" +
             "ЁЯТб р╕ер╕нр╕Зр╕Др╕│р╕Цр╕▓р╕бр╕нр╕╖р╣Ир╕Щ:\n" +
             "  тАв \"р╕Бр╕▓р╕гр╣Мр╣Ар╕Фр╕╡р╕вр╕Щр╕нр╕┤р╕Щр╕Фр╕▒р╕кр╕Чр╕гр╕╡р╕кр╣М invoice\" - р╕ер╕нр╕Зр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕нр╕╖р╣Ир╕Щ\n" +
             "  тАв \"р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Вр╕▓р╕вр╕Фр╕╡р╕Чр╕╡р╣Ир╕кр╕╕р╕Ф 6 р╣Ар╕Фр╕╖р╕нр╕Щ\" - р╕Фр╕╣р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Вр╕▓р╕вр╕Фр╕╡\n" +
             "  тАв \"р╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Ар╕вр╕нр╕░р╕кр╕╕р╕Ф\" - р╕Фр╕╣р╕ир╕╣р╕Щр╕вр╣Мр╕Чр╕╡р╣Ир╕Вр╕▓р╕вр╕Фр╕╡\n" +
             "  тАв \"р╕вр╕нр╕Ф invoice р╣Бр╕Хр╣Ир╕ер╕░р╣Ар╕Фр╕╖р╕нр╕Щ\" - р╕Фр╕╣р╕кр╕Цр╕┤р╕Хр╕┤р╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ"
    }
  };
}

// ============================================
// р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 2: р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕Хр╣Ир╣Ар╕Ыр╣Зр╕Щ object р╕зр╣Ир╕▓р╕З
// ============================================
const firstItem = items[0].json;
if (!firstItem || Object.keys(firstItem).length === 0 || !firstItem.inv_no) {
  return {
    json: {
      reply: "р╕Вр╕нр╕нр╕ар╕▒р╕вр╕Др╕гр╕▒р╕Ъ р╣Др╕бр╣Ир╕Юр╕Ъ invoice р╕Вр╕нр╕Зр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Щр╕╡р╣Й ЁЯШФ\n\n" +
             "ЁЯТб р╕ер╕нр╕Зр╕Др╕│р╕Цр╕▓р╕бр╕нр╕╖р╣Ир╕Щ:\n" +
             "  тАв \"р╕Бр╕▓р╕гр╣Мр╣Ар╕Фр╕╡р╕вр╕Щр╕нр╕┤р╕Щр╕Фр╕▒р╕кр╕Чр╕гр╕╡р╕кр╣М invoice\" - р╕ер╕нр╕Зр╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕нр╕╖р╣Ир╕Щ\n" +
             "  тАв \"р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Вр╕▓р╕вр╕Фр╕╡р╕Чр╕╡р╣Ир╕кр╕╕р╕Ф 6 р╣Ар╕Фр╕╖р╕нр╕Щ\"\n" +
             "  тАв \"р╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Ар╕вр╕нр╕░р╕кр╕╕р╕Ф\"\n" +
             "  тАв \"р╕вр╕нр╕Ф invoice р╣Бр╕Хр╣Ир╕ер╕░р╣Ар╕Фр╕╖р╕нр╕Щ\""
    }
  };
}

// ============================================
// р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 3: р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕е - Format response
// ============================================
const invoices = items.map(item => item.json);
const firstInvoice = invoices[0];
const customerName = firstInvoice.customer_name || firstInvoice.customer_no || 'р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕';
const customerNo = firstInvoice.customer_no || '';

// р╕Др╕│р╕Щр╕зр╕Ур╕вр╕нр╕Фр╕гр╕зр╕б
const totalAmount = invoices.reduce((sum, inv) => {
  const amount = parseFloat(inv.total_amount || 0);
  return sum + amount;
}, 0);

let reply = `ЁЯУЛ Invoice р╕Вр╕нр╕Зр╕ер╕╣р╕Бр╕Др╣Йр╕▓: ${customerName}`;
if (customerNo) {
  reply += ` (${customerNo})`;
}
reply += '\n\n';

reply += `р╕Ир╕│р╕Щр╕зр╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: ${invoices.length} р╕гр╕▓р╕вр╕Бр╕▓р╕г\n`;
reply += `р╕вр╕нр╕Фр╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: ${totalAmount.toLocaleString('th-TH', {minimumFractionDigits: 2})} р╕Ър╕▓р╕Ч\n\n`;
reply += 'р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕ер╣Ир╕▓р╕кр╕╕р╕Ф:\n';

// р╣Бр╕кр╕Фр╕З invoice р╕кр╕╣р╕Зр╕кр╕╕р╕Ф 10 р╕гр╕▓р╕вр╕Бр╕▓р╕г
invoices.slice(0, 10).forEach((invoice, index) => {
  const invNo = invoice.inv_no || 'N/A';
  const invDate = invoice.inv_date || invoice.inv_posting_date || 'N/A';
  const amount = parseFloat(invoice.total_amount || 0);
  
  reply += `${index + 1}. ${invNo} - ${invDate} - ${amount.toLocaleString('th-TH', {minimumFractionDigits: 2})} р╕Ър╕▓р╕Ч\n`;
});

// р╕Цр╣Йр╕▓р╕бр╕╡р╕бр╕▓р╕Бр╕Бр╕зр╣Ир╕▓ 10 р╕гр╕▓р╕вр╕Бр╕▓р╕г
if (invoices.length > 10) {
  reply += `\n... р╣Бр╕ер╕░р╕нр╕╡р╕Б ${invoices.length - 10} р╕гр╕▓р╕вр╕Бр╕▓р╕г\n`;
}

reply += '\nтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ\n';
reply += 'ЁЯТб р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕Фр╕╣р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б?\n';

// Contextual suggestions
if (invoices[0].inv_no) {
  reply += `тАв "${invoices[0].inv_no}" - р╕Фр╕╣р╕гр╕▓р╕вр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф invoice р╕Щр╕╡р╣Й\n`;
}
reply += 'тАв "р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╣Др╕лр╕Щр╕вр╕нр╕Фр╣Ар╕вр╕нр╕░р╕кр╕╕р╕Ф" - р╕Фр╕╣р╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕вр╕нр╕Фр╣Ар╕вр╕нр╕░р╕кр╕╕р╕Ф\n';
reply += 'тАв "р╕вр╕нр╕Ф invoice р╣Бр╕Хр╣Ир╕ер╕░р╣Ар╕Фр╕╖р╕нр╕Щ" - р╕Фр╕╣р╕кр╕Цр╕┤р╕Хр╕┤р╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ\n';
reply += 'тАв "р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Вр╕▓р╕вр╕Фр╕╡р╕Чр╕╡р╣Ир╕кр╕╕р╕Ф 6 р╣Ар╕Фр╕╖р╕нр╕Щ" - р╕Фр╕╣р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Вр╕▓р╕вр╕Фр╕╡\n';

// р╕Цр╣Йр╕▓р╕бр╕╡р╕Кр╕╖р╣Ир╕нр╕ер╕╣р╕Бр╕Др╣Йр╕▓ р╣Бр╕Щр╕░р╕Щр╕│р╣Гр╕лр╣Йр╕Фр╕╣р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕ер╕╣р╕Бр╕Др╣Йр╕▓р╕Щр╕╡р╣Йр╕Лр╕╖р╣Йр╕н
if (customerName && customerName !== 'р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕') {
  reply += `тАв "р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕нр╕░р╣Др╕гр╕Чр╕╡р╣И ${customerName} р╕Лр╕╖р╣Йр╕нр╕Ър╣Ир╕нр╕в" - р╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕кр╕┤р╕Щр╕Др╣Йр╕▓`;
}

return { json: { reply: reply } };
