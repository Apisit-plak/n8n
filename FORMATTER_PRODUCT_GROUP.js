// n8n Code Node - Product Group Sales Formatter with Contextual Suggestions
// р╣Гр╕Кр╣Йр╕лр╕ер╕▒р╕З Execute SQL Query node р╕кр╕│р╕лр╕гр╕▒р╕Ъ product_group_sales action
// р╕зр╕▓р╕Зр╣Вр╕Др╣Йр╕Фр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Щр╕╡р╣Йр╣Гр╕Щ Code In JavaScript node

// р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕гр╕╖р╕нр╣Др╕бр╣И
const items = $input.all();

// ============================================
// р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 1: р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕ер╕в
// ============================================
if (!items || items.length === 0) {
  return {
    json: {
      reply: "р╕Вр╕нр╕нр╕ар╕▒р╕вр╕Др╕гр╕▒р╕Ъ р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щр╕Кр╣Ир╕зр╕Зр╣Ар╕зр╕ер╕▓р╕Чр╕╡р╣Ир╕гр╕░р╕Ър╕╕ ЁЯШФ\n\n" +
             "ЁЯТб р╕ер╕нр╕Зр╕Др╕│р╕Цр╕▓р╕бр╕нр╕╖р╣Ир╕Щ:\n" +
             "  тАв \"product р╣Бр╕вр╕Бр╕Хр╕▓р╕бр╕Бр╕ер╕╕р╣Ир╕б 1 р╕Ыр╕╡\"\n" +
             "  тАв \"р╕вр╕нр╕Фр╕Вр╕▓р╕вр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Бр╕Хр╣Ир╕ер╕░р╕Бр╕ер╕╕р╣Ир╕бр╕Ыр╕╡р╕Чр╕╡р╣Ир╣Бр╕ер╣Йр╕з\"\n" +
             "  тАв \"р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Вр╕▓р╕вр╕Фр╕╡р╕Чр╕╡р╣Ир╕кр╕╕р╕Ф 6 р╣Ар╕Фр╕╖р╕нр╕Щ\"\n" +
             "  тАв \"р╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Ар╕вр╕нр╕░р╕кр╕╕р╕Ф\""
    }
  };
}

// ============================================
// р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 2: р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕Хр╣Ир╣Ар╕Ыр╣Зр╕Щ object р╕зр╣Ир╕▓р╕З
// ============================================
const firstItem = items[0].json;
if (!firstItem || Object.keys(firstItem).length === 0) {
  return {
    json: {
      reply: "р╕Вр╕нр╕нр╕ар╕▒р╕вр╕Др╕гр╕▒р╕Ъ р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Бр╕ер╕╕р╣Ир╕бр╕кр╕┤р╕Щр╕Др╣Йр╕▓ ЁЯШФ\n\n" +
             "ЁЯТб р╕ер╕нр╕Зр╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╣Ар╕Ыр╣Зр╕Щ:\n" +
             "  тАв \"product р╣Бр╕вр╕Бр╕Хр╕▓р╕бр╕Бр╕ер╕╕р╣Ир╕б 1 р╕Ыр╕╡\"\n" +
             "  тАв \"р╕вр╕нр╕Фр╕Вр╕▓р╕вр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Бр╕Хр╣Ир╕ер╕░р╕Бр╕ер╕╕р╣Ир╕бр╕Ыр╕╡р╕Чр╕╡р╣Ир╣Бр╕ер╣Йр╕з\"\n" +
             "  тАв \"р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Вр╕▓р╕вр╕Фр╕╡р╕Чр╕╡р╣Ир╕кр╕╕р╕Ф 6 р╣Ар╕Фр╕╖р╕нр╕Щ\"\n" +
             "  тАв \"р╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Ар╕вр╕нр╕░р╕кр╕╕р╕Фр╕Ыр╕╡р╕Чр╕╡р╣Ир╣Бр╕ер╣Йр╕з\""
    }
  };
}

// ============================================
// р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 3: р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕е - Format response
// ============================================
const groups = items.map(item => item.json);
const topGroup = groups[0]; // р╕Бр╕ер╕╕р╣Ир╕бр╕нр╕▒р╕Щр╕Фр╕▒р╕Ъ 1

// р╕Др╕│р╕Щр╕зр╕Ур╕вр╕нр╕Фр╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
const totalAmount = groups.reduce((sum, g) => sum + parseFloat(g.total_amount || 0), 0);

// р╕Бр╕│р╕лр╕Щр╕Ф title р╕Хр╕▓р╕б group_by type (р╕Ир╕▓р╕Б input data р╕лр╕гр╕╖р╕н default)
const groupByType = items[0]?.json?.group_by_type || 'р╕Бр╕ер╕╕р╣Ир╕б'; // fallback
const titles = {
  'brand': 'ЁЯУК р╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Бр╕вр╕Бр╕Хр╕▓р╕бр╕вр╕╡р╣Ир╕лр╣Йр╕н (Brand)',
  'ir_code': 'ЁЯУК р╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Бр╕вр╕Бр╕Хр╕▓р╕бр╕лр╕бр╕зр╕Фр╕лр╕бр╕╣р╣И (Category)',
  'prefix': 'ЁЯУК р╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Бр╕вр╕Бр╕Хр╕▓р╕б Series',
  'item_type': 'ЁЯУК р╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Бр╕вр╕Бр╕Хр╕▓р╕бр╕Ыр╕гр╕░р╣Ар╕ар╕Чр╕кр╕┤р╕Щр╕Др╣Йр╕▓',
  'department': 'ЁЯУК р╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Бр╕вр╕Бр╕Хр╕▓р╕бр╕ир╕╣р╕Щр╕вр╣М/р╕лр╕Щр╣Ир╕зр╕вр╕Зр╕▓р╕Щ',
  'number': 'ЁЯУК р╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Бр╕вр╕Бр╕Хр╕▓р╕бр╕Бр╕ер╕╕р╣Ир╕бр╕кр╕┤р╕Щр╕Др╣Йр╕▓ (Group 1-9)'
};

let reply = `${titles[groupByType] || titles['number']}\n\n`;

groups.forEach((group, index) => {
  const amount = parseFloat(group.total_amount || 0);
  const percentage = totalAmount > 0 ? (amount / totalAmount * 100).toFixed(1) : 0;
  const groupName = group.product_group || group.group_name || `Group ${index + 1}`;
  
  reply += `${index + 1}. ЁЯУж ${groupName}\n`;
  reply += `   ЁЯТ░ р╕вр╕нр╕Фр╕Вр╕▓р╕в: ${amount.toLocaleString('th-TH', {minimumFractionDigits: 2})} р╕Ър╕▓р╕Ч (${percentage}%)\n`;
  
  // р╣Бр╕кр╕Фр╕Зр╕Ир╕│р╕Щр╕зр╕Щр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Бр╕ер╕░ Invoice
  const productCount = group.product_count || group.item_count || 0;
  const invoiceCount = group.invoice_count || 0;
  
  if (productCount > 0 || invoiceCount > 0) {
    reply += '   ЁЯУК ';
    if (productCount > 0) {
      reply += `р╕кр╕┤р╕Щр╕Др╣Йр╕▓: ${productCount} р╕гр╕▓р╕вр╕Бр╕▓р╕г`;
    }
    if (invoiceCount > 0) {
      if (productCount > 0) reply += ' | ';
      reply += `${invoiceCount} Invoice`;
    }
    reply += '\n';
  }
  
  // р╣Бр╕кр╕Фр╕Зр╕Ир╕│р╕Щр╕зр╕Щр╕гр╕зр╕б (р╕Цр╣Йр╕▓р╕бр╕╡)
  if (group.total_quantity) {
    reply += `   ЁЯУж р╕Ир╕│р╕Щр╕зр╕Щр╕гр╕зр╕б: ${parseFloat(group.total_quantity).toLocaleString('th-TH')} р╕Кр╕┤р╣Йр╕Щ\n`;
  }
  
  reply += '\n';
});

reply += 'тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ\n';
reply += 'ЁЯТб р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б?\n';

// Contextual suggestions р╕Хр╕▓р╕бр╕Бр╕ер╕╕р╣Ир╕бр╕нр╕▒р╕Щр╕Фр╕▒р╕Ъ 1
const topGroupName = topGroup.product_group || topGroup.group_name || 'Group 1';
reply += `тАв "р╕кр╕┤р╕Щр╕Др╣Йр╕▓ ${topGroupName} р╕Вр╕▓р╕вр╕Фр╕╡р╕Чр╕╡р╣Ир╕кр╕╕р╕Фр╕Хр╕▒р╕зр╣Др╕лр╕Щ" - р╕Фр╕╣р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Гр╕Щр╕Бр╕ер╕╕р╣Ир╕б\n`;
reply += `тАв "р╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Вр╕▓р╕в ${topGroupName} р╣Ар╕вр╕нр╕░р╕кр╕╕р╕Ф" - р╕Фр╕╣р╕ир╕╣р╕Щр╕вр╣М\n`;
reply += 'тАв "р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Вр╕▓р╕вр╕Фр╕╡р╕Чр╕╡р╣Ир╕кр╕╕р╕Ф 1 р╕Ыр╕╡" - р╕Фр╕╣р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Вр╕▓р╕вр╕Фр╕╡р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф\n';
reply += 'тАв "р╕вр╕нр╕Ф invoice р╣Бр╕Хр╣Ир╕ер╕░р╣Ар╕Фр╕╖р╕нр╕Щ" - р╕Фр╕╣р╣Бр╕Щр╕зр╣Вр╕Щр╣Йр╕бр╕гр╕▓р╕вр╣Ар╕Фр╕╖р╕нр╕Щ\n';
reply += 'тАв "р╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Ар╕вр╕нр╕░р╕кр╕╕р╕Ф 6 р╣Ар╕Фр╕╖р╕нр╕Щ" - р╕Фр╕╣р╕ир╕╣р╕Щр╕вр╣Мр╕Чр╕╡р╣Ир╕Вр╕▓р╕вр╕Фр╕╡';

return { json: { reply: reply } };
