// n8n Code Node - Top Items Formatter with Contextual Suggestions
// ‡πÉ‡∏ä‡πâ‡∏´‡∏•‡∏±‡∏á Execute SQL Query node ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö top_items action
// ‡∏ß‡∏≤‡∏á‡πÇ‡∏Ñ‡πâ‡∏î‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î‡∏ô‡∏µ‡πâ‡πÉ‡∏ô Code In JavaScript node

// ‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö‡∏ß‡πà‡∏≤‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏´‡∏£‡∏∑‡∏≠‡πÑ‡∏°‡πà
const items = $input.all();

// ============================================
// ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 1: ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏•‡∏¢
// ============================================
if (!items || items.length === 0) {
  return {
    json: {
      reply: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ üòî\n\n" +
             "üîç ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:\n" +
             "  ‚Ä¢ ‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•\n" +
             "  ‚Ä¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ\n\n" +
             "üí° ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô:\n" +
             "  ‚Ä¢ \"‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß\" - ‡∏î‡∏π‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß\n" +
             "  ‚Ä¢ \"TOP 10 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô\" - ‡∏î‡∏π 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô\n" +
             "  ‚Ä¢ \"‡∏≠‡∏∞‡πÑ‡∏£‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î 1 ‡∏õ‡∏µ\" - ‡∏î‡∏π 1 ‡∏õ‡∏µ\n" +
             "  ‚Ä¢ \"‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÑ‡∏´‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î\" - ‡∏î‡∏π‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ"
    }
  };
}

// ============================================
// ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 2: ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÅ‡∏ï‡πà‡πÄ‡∏õ‡πá‡∏ô object ‡∏ß‡πà‡∏≤‡∏á
// ============================================
const firstItem = items[0].json;
if (!firstItem || Object.keys(firstItem).length === 0 || !firstItem.item_no) {
  return {
    json: {
      reply: "‡∏Ç‡∏≠‡∏≠‡∏†‡∏±‡∏¢‡∏Ñ‡∏£‡∏±‡∏ö ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ó‡∏µ‡πà‡∏£‡∏∞‡∏ö‡∏∏ üòî\n\n" +
             "üîç ‡∏™‡∏≤‡πÄ‡∏´‡∏ï‡∏∏‡∏ó‡∏µ‡πà‡πÄ‡∏õ‡πá‡∏ô‡πÑ‡∏õ‡πÑ‡∏î‡πâ:\n" +
             "  ‚Ä¢ ‡∏õ‡∏µ‡∏ô‡∏µ‡πâ‡πÄ‡∏û‡∏¥‡πà‡∏á‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏ï‡πâ‡∏ô ‡∏≠‡∏≤‡∏à‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏û‡∏µ‡∏¢‡∏á‡∏û‡∏≠\n" +
             "  ‚Ä¢ ‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡πÉ‡∏ô‡∏ä‡πà‡∏ß‡∏á‡πÄ‡∏ß‡∏•‡∏≤‡∏ô‡∏µ‡πâ\n\n" +
             "üí° ‡∏•‡∏≠‡∏á‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡πÄ‡∏õ‡πá‡∏ô:\n" +
             "  ‚Ä¢ \"‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÅ‡∏•‡πâ‡∏ß\"\n" +
             "  ‚Ä¢ \"TOP 10 ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô\"\n" +
             "  ‚Ä¢ \"product ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°\"\n" +
             "  ‚Ä¢ \"‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÑ‡∏´‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô\""
    }
  };
}

// ============================================
// ‡∏Å‡∏£‡∏ì‡∏µ‡∏ó‡∏µ‡πà 3: ‡∏°‡∏µ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏• - Format response
// ============================================
const products = items.map(item => item.json);
const topProduct = products[0]; // ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1

let reply = `üèÜ ‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ‡∏ó‡∏µ‡πà‡∏™‡∏∏‡∏î (TOP ${products.length})\n\n`;

products.forEach((product, index) => {
  reply += `üì¶ ${index + 1}. ${product.item_description || product.item_no}\n`;
  reply += `   üí∞ ‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢: ${parseFloat(product.total_amount || 0).toLocaleString('th-TH', {minimumFractionDigits: 2})} ‡∏ö‡∏≤‡∏ó\n`;
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÅ‡∏•‡∏∞ Invoice
  if (product.total_quantity) {
    reply += `   üìä ‡∏à‡∏≥‡∏ô‡∏ß‡∏ô: ${parseFloat(product.total_quantity).toLocaleString('th-TH')} ‡∏ä‡∏¥‡πâ‡∏ô`;
  }
  if (product.invoice_count) {
    reply += ` | ${product.invoice_count} Invoice\n`;
  } else {
    reply += '\n';
  }
  
  // ‡πÅ‡∏™‡∏î‡∏á‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
  if (product.department_count) {
    reply += `   üè¢ ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ ${product.department_count} ‡∏®‡∏π‡∏ô‡∏¢‡πå`;
    
    // ‡πÅ‡∏™‡∏î‡∏á‡∏ä‡∏∑‡πà‡∏≠‡∏®‡∏π‡∏ô‡∏¢‡πå (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)
    if (product.top_departments) {
      const depts = product.top_departments.split(',').slice(0, 3);
      reply += `: ${depts.join(', ')}`;
    }
    reply += '\n';
  }
  
  reply += '\n';
});

reply += '‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n';
reply += 'üí° ‡∏ï‡πâ‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ß‡∏¥‡πÄ‡∏Ñ‡∏£‡∏≤‡∏∞‡∏´‡πå‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°?\n';

// Contextual suggestions ‡∏ï‡∏≤‡∏°‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏≠‡∏±‡∏ô‡∏î‡∏±‡∏ö 1
if (topProduct.item_no) {
  reply += `‚Ä¢ "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤ ${topProduct.item_no} ‡∏Ç‡∏≤‡∏¢‡πÑ‡∏î‡πâ‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÑ‡∏´‡∏ô‡∏ö‡πâ‡∏≤‡∏á" - ‡∏î‡∏π‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î\n`;
}
reply += '‚Ä¢ "‡∏™‡∏¥‡∏ô‡∏Ñ‡πâ‡∏≤‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ 1 ‡∏õ‡∏µ" - ‡∏î‡∏π‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏∞‡∏¢‡∏∞‡∏¢‡∏≤‡∏ß\n';
reply += '‚Ä¢ "product ‡πÅ‡∏¢‡∏Å‡∏ï‡∏≤‡∏°‡∏Å‡∏•‡∏∏‡πà‡∏°" - ‡∏î‡∏π‡∏ï‡∏≤‡∏°‡∏´‡∏°‡∏ß‡∏î‡∏´‡∏°‡∏π‡πà\n';
reply += '‚Ä¢ "‡∏®‡∏π‡∏ô‡∏¢‡πå‡πÑ‡∏´‡∏ô‡∏¢‡∏≠‡∏î‡∏Ç‡∏≤‡∏¢‡πÄ‡∏¢‡∏≠‡∏∞‡∏™‡∏∏‡∏î 6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" - ‡∏î‡∏π‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏ó‡∏µ‡πà‡∏Ç‡∏≤‡∏¢‡∏î‡∏µ\n';
reply += '‚Ä¢ "‡∏¢‡∏≠‡∏î invoice ‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏î‡∏∑‡∏≠‡∏ô" - ‡∏î‡∏π‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô';

return { json: { reply: reply } };
