// n8n Code Node - Response Formatters with Contextual Suggestions
// à¹ƒà¸Šà¹‰à¸«à¸¥à¸±à¸‡ SQL Query nodes à¸ªà¸³à¸«à¸£à¸±à¸šà¹à¸•à¹ˆà¸¥à¸° action

// ============================================
// 1. TOP CENTER FORMATTER
// ============================================
function formatTopCenterResponse() {
  const items = $input.all();
  
  // à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  if (!items || items.length === 0 || !items[0].json || Object.keys(items[0].json).length === 0) {
    return {
      json: {
        reply: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¸£à¸±à¸š à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸£à¸°à¸šà¸¸ ğŸ˜”\n\n" +
               "ğŸ” à¸ªà¸²à¹€à¸«à¸•à¸¸à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹„à¸›à¹„à¸”à¹‰:\n" +
               "  â€¢ à¸›à¸µà¸™à¸µà¹‰à¹€à¸à¸´à¹ˆà¸‡à¹€à¸£à¸´à¹ˆà¸¡à¸•à¹‰à¸™ à¸­à¸²à¸ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸µà¸¢à¸‡à¸à¸­\n" +
               "  â€¢ à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸\n\n" +
               "ğŸ’¡ à¸¥à¸­à¸‡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™:\n" +
               "  â€¢ \"à¸¨à¸¹à¸™à¸¢à¹Œà¹„à¸«à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢à¹€à¸¢à¸­à¸°à¸ªà¸¸à¸”à¸›à¸µà¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§\"\n" +
               "  â€¢ \"à¸¨à¸¹à¸™à¸¢à¹Œà¸¢à¸­à¸”à¸‚à¸²à¸¢ 12 à¹€à¸”à¸·à¸­à¸™\"\n" +
               "  â€¢ \"TOP 5 à¸¨à¸¹à¸™à¸¢à¹Œà¸¢à¸­à¸”à¸‚à¸²à¸¢ 6 à¹€à¸”à¸·à¸­à¸™\"\n" +
               "  â€¢ \"à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”à¸›à¸µà¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§\""
      }
    };
  }
  
  // à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  const centers = items.map(item => item.json);
  const topCenter = centers[0]; // à¸¨à¸¹à¸™à¸¢à¹Œà¸­à¸±à¸™à¸”à¸±à¸š 1
  
  let reply = `ğŸ“Š à¸¨à¸¹à¸™à¸¢à¹Œ/à¸«à¸™à¹ˆà¸§à¸¢à¸‡à¸²à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢à¹€à¸¢à¸­à¸°à¸ªà¸¸à¸” (TOP ${centers.length})\n\n`;
  
  centers.forEach((center, index) => {
    reply += `ğŸ¢ ${index + 1}. ${center.department_name || center.department} (${center.department})\n`;
    reply += `   ğŸ’° à¸¢à¸­à¸”à¸‚à¸²à¸¢: ${parseFloat(center.total_amount || 0).toLocaleString('th-TH', {minimumFractionDigits: 2})} à¸šà¸²à¸—\n`;
    reply += `   ğŸ“„ Invoice: ${center.invoice_count || 0} à¸£à¸²à¸¢à¸à¸²à¸£\n\n`;
  });
  
  reply += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  reply += 'ğŸ’¡ à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡?\n';
  reply += `â€¢ "${topCenter.department_name} à¸‚à¸²à¸¢à¸ªà¸´à¸™à¸„à¹‰à¸²à¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡" - à¸”à¸¹à¸ªà¸´à¸™à¸„à¹‰à¸²à¸—à¸µà¹ˆà¸‚à¸²à¸¢\n`;
  reply += 'â€¢ "à¸¨à¸¹à¸™à¸¢à¹Œà¸¢à¸­à¸”à¸‚à¸²à¸¢ 1 à¸›à¸µ" - à¸”à¸¹à¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¸£à¸°à¸¢à¸°à¸¢à¸²à¸§\n';
  reply += 'â€¢ "à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” 6 à¹€à¸”à¸·à¸­à¸™" - à¸”à¸¹à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µ\n';
  reply += 'â€¢ "à¸¢à¸­à¸” invoice à¹à¸•à¹ˆà¸¥à¸°à¹€à¸”à¸·à¸­à¸™" - à¸”à¸¹à¸ªà¸–à¸´à¸•à¸´à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™';
  
  return { json: { reply: reply } };
}

// ============================================
// 2. TOP ITEMS FORMATTER
// ============================================
function formatTopItemsResponse() {
  const items = $input.all();
  
  // à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  if (!items || items.length === 0 || !items[0].json || Object.keys(items[0].json).length === 0) {
    return {
      json: {
        reply: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¸£à¸±à¸š à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸£à¸°à¸šà¸¸ ğŸ˜”\n\n" +
               "ğŸ” à¸ªà¸²à¹€à¸«à¸•à¸¸à¸—à¸µà¹ˆà¹€à¸›à¹‡à¸™à¹„à¸›à¹„à¸”à¹‰:\n" +
               "  â€¢ à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¹€à¸¥à¸·à¸­à¸à¸­à¸²à¸ˆà¸¢à¸±à¸‡à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥\n" +
               "  â€¢ à¹„à¸¡à¹ˆà¸¡à¸µà¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸™à¸µà¹‰\n\n" +
               "ğŸ’¡ à¸¥à¸­à¸‡à¹€à¸›à¸¥à¸µà¹ˆà¸¢à¸™à¹€à¸›à¹‡à¸™:\n" +
               "  â€¢ \"à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”à¸›à¸µà¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§\"\n" +
               "  â€¢ \"TOP 10 à¸ªà¸´à¸™à¸„à¹‰à¸² 6 à¹€à¸”à¸·à¸­à¸™\"\n" +
               "  â€¢ \"à¸­à¸°à¹„à¸£à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” 1 à¸›à¸µ\"\n" +
               "  â€¢ \"product à¹à¸¢à¸à¸•à¸²à¸¡à¸à¸¥à¸¸à¹ˆà¸¡\""
      }
    };
  }
  
  // à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  const products = items.map(item => item.json);
  const topProduct = products[0]; // à¸ªà¸´à¸™à¸„à¹‰à¸²à¸­à¸±à¸™à¸”à¸±à¸š 1
  
  let reply = `ğŸ† à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” (TOP ${products.length})\n\n`;
  
  products.forEach((product, index) => {
    reply += `ğŸ“¦ ${index + 1}. ${product.item_description || product.item_no}\n`;
    reply += `   ğŸ’° à¸¢à¸­à¸”à¸‚à¸²à¸¢: ${parseFloat(product.total_amount || 0).toLocaleString('th-TH', {minimumFractionDigits: 2})} à¸šà¸²à¸—\n`;
    reply += `   ğŸ“Š à¸ˆà¸³à¸™à¸§à¸™: ${product.total_quantity || 0} à¸Šà¸´à¹‰à¸™ | ${product.invoice_count || 0} Invoice\n`;
    if (product.department_count) {
      reply += `   ğŸ¢ à¸‚à¸²à¸¢à¹„à¸”à¹‰ ${product.department_count} à¸¨à¸¹à¸™à¸¢à¹Œ\n`;
    }
    reply += '\n';
  });
  
  reply += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  reply += 'ğŸ’¡ à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡?\n';
  reply += `â€¢ "à¸ªà¸´à¸™à¸„à¹‰à¸² ${topProduct.item_no} à¸‚à¸²à¸¢à¹„à¸”à¹‰à¸¨à¸¹à¸™à¸¢à¹Œà¹„à¸«à¸™à¸šà¹‰à¸²à¸‡" - à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸”\n`;
  reply += 'â€¢ "à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µ 1 à¸›à¸µ" - à¸”à¸¹à¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¸£à¸°à¸¢à¸°à¸¢à¸²à¸§\n';
  reply += 'â€¢ "product à¹à¸¢à¸à¸•à¸²à¸¡à¸à¸¥à¸¸à¹ˆà¸¡" - à¸”à¸¹à¸•à¸²à¸¡à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆ\n';
  reply += 'â€¢ "à¸¨à¸¹à¸™à¸¢à¹Œà¹„à¸«à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢à¹€à¸¢à¸­à¸°à¸ªà¸¸à¸” 6 à¹€à¸”à¸·à¸­à¸™" - à¸”à¸¹à¸¨à¸¹à¸™à¸¢à¹Œà¸—à¸µà¹ˆà¸‚à¸²à¸¢à¸”à¸µ';
  
  return { json: { reply: reply } };
}

// ============================================
// 3. MONTHLY SALES FORMATTER
// ============================================
function formatMonthlySalesResponse() {
  const items = $input.all();
  
  // à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  if (!items || items.length === 0 || !items[0].json || Object.keys(items[0].json).length === 0) {
    return {
      json: {
        reply: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¸£à¸±à¸š à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸£à¸°à¸šà¸¸ ğŸ˜”\n\n" +
               "ğŸ’¡ à¸¥à¸­à¸‡à¸„à¸³à¸–à¸²à¸¡à¸­à¸·à¹ˆà¸™:\n" +
               "  â€¢ \"à¸¢à¸­à¸” invoice à¹à¸•à¹ˆà¸¥à¸°à¹€à¸”à¸·à¸­à¸™ 12 à¹€à¸”à¸·à¸­à¸™\"\n" +
               "  â€¢ \"à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™à¸›à¸µà¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§\"\n" +
               "  â€¢ \"à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” 6 à¹€à¸”à¸·à¸­à¸™\"\n" +
               "  â€¢ \"à¸¨à¸¹à¸™à¸¢à¹Œà¹„à¸«à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢à¹€à¸¢à¸­à¸°à¸ªà¸¸à¸”\""
      }
    };
  }
  
  // à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  const months = items.map(item => item.json);
  
  // à¸«à¸²à¹€à¸”à¸·à¸­à¸™à¸—à¸µà¹ˆà¸¢à¸­à¸”à¸ªà¸¹à¸‡à¸ªà¸¸à¸”à¹à¸¥à¸°à¸•à¹ˆà¸³à¸ªà¸¸à¸”
  const maxMonth = months.reduce((max, m) => parseFloat(m.total_amount) > parseFloat(max.total_amount) ? m : max);
  const minMonth = months.reduce((min, m) => parseFloat(m.total_amount) < parseFloat(min.total_amount) ? m : min);
  
  let reply = `ğŸ“ˆ à¸¢à¸­à¸” Invoice à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™ - ${months.length} à¹€à¸”à¸·à¸­à¸™à¸¢à¹‰à¸­à¸™à¸«à¸¥à¸±à¸‡\n\n`;
  
  months.forEach((month) => {
    const isMax = month.year_month === maxMonth.year_month;
    const maxMark = isMax ? ' â­ à¸ªà¸¹à¸‡à¸ªà¸¸à¸”' : '';
    reply += `${month.year_month}: ğŸ’° ${parseFloat(month.total_amount || 0).toLocaleString('th-TH', {minimumFractionDigits: 0})} à¸šà¸²à¸— `;
    reply += `(${month.invoice_count} Invoice)${maxMark}\n`;
  });
  
  const avgAmount = months.reduce((sum, m) => sum + parseFloat(m.total_amount), 0) / months.length;
  
  reply += '\nğŸ“Š à¸ªà¸£à¸¸à¸›:\n';
  reply += `â€¢ à¹€à¸”à¸·à¸­à¸™à¸—à¸µà¹ˆà¸¢à¸­à¸”à¸ªà¸¹à¸‡à¸ªà¸¸à¸”: ${maxMonth.year_month} (${parseFloat(maxMonth.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 0})} à¸šà¸²à¸—)\n`;
  reply += `â€¢ à¹€à¸”à¸·à¸­à¸™à¸—à¸µà¹ˆà¸¢à¸­à¸”à¸•à¹ˆà¸³à¸ªà¸¸à¸”: ${minMonth.year_month} (${parseFloat(minMonth.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 0})} à¸šà¸²à¸—)\n`;
  reply += `â€¢ à¸¢à¸­à¸”à¹€à¸‰à¸¥à¸µà¹ˆà¸¢à¸•à¹ˆà¸­à¹€à¸”à¸·à¸­à¸™: ${avgAmount.toLocaleString('th-TH', {minimumFractionDigits: 0})} à¸šà¸²à¸—\n`;
  
  reply += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  reply += 'ğŸ’¡ à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡?\n';
  reply += `â€¢ "à¹€à¸”à¸·à¸­à¸™ ${maxMonth.year_month} à¸‚à¸²à¸¢à¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡" - à¸”à¸¹à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µ\n`;
  reply += `â€¢ "à¸¨à¸¹à¸™à¸¢à¹Œà¹„à¸«à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢à¹€à¸¢à¸­à¸°à¸ªà¸¸à¸”à¹€à¸”à¸·à¸­à¸™ ${maxMonth.year_month}" - à¸”à¸¹à¸¨à¸¹à¸™à¸¢à¹Œ\n`;
  reply += 'â€¢ "product à¹à¸¢à¸à¸•à¸²à¸¡à¸à¸¥à¸¸à¹ˆà¸¡ 1 à¸›à¸µ" - à¸”à¸¹à¸•à¸²à¸¡à¸«à¸¡à¸§à¸”à¸«à¸¡à¸¹à¹ˆ\n';
  reply += 'â€¢ "à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” 6 à¹€à¸”à¸·à¸­à¸™" - à¸”à¸¹à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µ';
  
  return { json: { reply: reply } };
}

// ============================================
// 4. PRODUCT GROUP SALES FORMATTER
// ============================================
function formatProductGroupSalesResponse() {
  const items = $input.all();
  
  // à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  if (!items || items.length === 0 || !items[0].json || Object.keys(items[0].json).length === 0) {
    return {
      json: {
        reply: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¸£à¸±à¸š à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹ƒà¸™à¸Šà¹ˆà¸§à¸‡à¹€à¸§à¸¥à¸²à¸—à¸µà¹ˆà¸£à¸°à¸šà¸¸ ğŸ˜”\n\n" +
               "ğŸ’¡ à¸¥à¸­à¸‡à¸„à¸³à¸–à¸²à¸¡à¸­à¸·à¹ˆà¸™:\n" +
               "  â€¢ \"product à¹à¸¢à¸à¸•à¸²à¸¡à¸à¸¥à¸¸à¹ˆà¸¡ 1 à¸›à¸µ\"\n" +
               "  â€¢ \"à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸ªà¸´à¸™à¸„à¹‰à¸²à¹à¸•à¹ˆà¸¥à¸°à¸à¸¥à¸¸à¹ˆà¸¡à¸›à¸µà¸—à¸µà¹ˆà¹à¸¥à¹‰à¸§\"\n" +
               "  â€¢ \"à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” 6 à¹€à¸”à¸·à¸­à¸™\"\n" +
               "  â€¢ \"à¸¨à¸¹à¸™à¸¢à¹Œà¹„à¸«à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢à¹€à¸¢à¸­à¸°à¸ªà¸¸à¸”\""
      }
    };
  }
  
  // à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  const groups = items.map(item => item.json);
  const topGroup = groups[0]; // à¸à¸¥à¸¸à¹ˆà¸¡à¸­à¸±à¸™à¸”à¸±à¸š 1
  const totalAmount = groups.reduce((sum, g) => sum + parseFloat(g.total_amount), 0);
  
  let reply = `ğŸ“Š à¸¢à¸­à¸”à¸‚à¸²à¸¢à¹à¸¢à¸à¸•à¸²à¸¡à¸à¸¥à¸¸à¹ˆà¸¡à¸ªà¸´à¸™à¸„à¹‰à¸²\n\n`;
  
  groups.forEach((group, index) => {
    const percentage = (parseFloat(group.total_amount) / totalAmount * 100).toFixed(1);
    reply += `${index + 1}. ğŸ“¦ ${group.product_group || 'N/A'}\n`;
    reply += `   ğŸ’° à¸¢à¸­à¸”à¸‚à¸²à¸¢: ${parseFloat(group.total_amount || 0).toLocaleString('th-TH', {minimumFractionDigits: 2})} à¸šà¸²à¸— (${percentage}%)\n`;
    reply += `   ğŸ“Š à¸ªà¸´à¸™à¸„à¹‰à¸²: ${group.product_count || 0} à¸£à¸²à¸¢à¸à¸²à¸£ | ${group.invoice_count || 0} Invoice\n\n`;
  });
  
  reply += 'â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  reply += 'ğŸ’¡ à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸§à¸´à¹€à¸„à¸£à¸²à¸°à¸«à¹Œà¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡?\n';
  reply += `â€¢ "à¸ªà¸´à¸™à¸„à¹‰à¸² ${topGroup.product_group} à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”à¸•à¸±à¸§à¹„à¸«à¸™" - à¸”à¸¹à¸ªà¸´à¸™à¸„à¹‰à¸²à¹ƒà¸™à¸à¸¥à¸¸à¹ˆà¸¡\n`;
  reply += `â€¢ "à¸¨à¸¹à¸™à¸¢à¹Œà¹„à¸«à¸™à¸‚à¸²à¸¢ ${topGroup.product_group} à¹€à¸¢à¸­à¸°à¸ªà¸¸à¸”" - à¸”à¸¹à¸¨à¸¹à¸™à¸¢à¹Œ\n`;
  reply += 'â€¢ "à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” 1 à¸›à¸µ" - à¸”à¸¹à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”\n';
  reply += 'â€¢ "à¸¢à¸­à¸” invoice à¹à¸•à¹ˆà¸¥à¸°à¹€à¸”à¸·à¸­à¸™" - à¸”à¸¹à¹à¸™à¸§à¹‚à¸™à¹‰à¸¡à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™';
  
  return { json: { reply: reply } };
}

// ============================================
// 5. CUSTOMER INVOICES FORMATTER
// ============================================
function formatCustomerInvoicesResponse() {
  const items = $input.all();
  
  // à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  if (!items || items.length === 0 || !items[0].json || Object.keys(items[0].json).length === 0) {
    return {
      json: {
        reply: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¸£à¸±à¸š à¹„à¸¡à¹ˆà¸à¸šà¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¸¥à¸¹à¸à¸„à¹‰à¸²à¸™à¸µà¹‰ ğŸ˜”\n\n" +
               "ğŸ’¡ à¸¥à¸­à¸‡à¸„à¸³à¸–à¸²à¸¡à¸­à¸·à¹ˆà¸™:\n" +
               "  â€¢ \"à¸à¸²à¸£à¹Œà¹€à¸”à¸µà¸¢à¸™à¸­à¸´à¸™à¸”à¸±à¸ªà¸—à¸£à¸µà¸ªà¹Œ invoice\" - à¸¥à¸­à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸²à¸­à¸·à¹ˆà¸™\n" +
               "  â€¢ \"à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” 6 à¹€à¸”à¸·à¸­à¸™\"\n" +
               "  â€¢ \"à¸¨à¸¹à¸™à¸¢à¹Œà¹„à¸«à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢à¹€à¸¢à¸­à¸°à¸ªà¸¸à¸”\"\n" +
               "  â€¢ \"à¸¢à¸­à¸” invoice à¹à¸•à¹ˆà¸¥à¸°à¹€à¸”à¸·à¸­à¸™\""
      }
    };
  }
  
  // à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  const invoices = items.map(item => item.json);
  const firstInvoice = invoices[0];
  const customerName = firstInvoice.customer_name || firstInvoice.customer_no;
  const totalAmount = invoices.reduce((sum, inv) => sum + parseFloat(inv.total_amount || 0), 0);
  
  let reply = `ğŸ“‹ Invoice à¸‚à¸­à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸²: ${customerName}\n\n`;
  reply += `à¸ˆà¸³à¸™à¸§à¸™à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: ${invoices.length} à¸£à¸²à¸¢à¸à¸²à¸£\n`;
  reply += `à¸¢à¸­à¸”à¸£à¸§à¸¡à¸—à¸±à¹‰à¸‡à¸«à¸¡à¸”: ${totalAmount.toLocaleString('th-TH', {minimumFractionDigits: 2})} à¸šà¸²à¸—\n\n`;
  reply += 'à¸£à¸²à¸¢à¸à¸²à¸£à¸¥à¹ˆà¸²à¸ªà¸¸à¸”:\n';
  
  invoices.slice(0, 10).forEach((invoice, index) => {
    // âš ï¸ à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡ invoice_no à¹à¸¥à¸° inv_no (à¹€à¸à¸·à¹ˆà¸­à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡ 2 format)
    const invNo = invoice.invoice_no || invoice.inv_no;
    reply += `${index + 1}. ${invNo} - ${invoice.inv_date} - ${parseFloat(invoice.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} à¸šà¸²à¸—\n`;
  });
  
  reply += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  reply += 'ğŸ’¡ à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡?\n';
  // âš ï¸ à¸£à¸­à¸‡à¸£à¸±à¸šà¸—à¸±à¹‰à¸‡ invoice_no à¹à¸¥à¸° inv_no
  const firstInvNo = invoices[0].invoice_no || invoices[0].inv_no;
  reply += `â€¢ "${firstInvNo}" - à¸”à¸¹à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” invoice à¸™à¸µà¹‰\n`;
  reply += 'â€¢ "à¸¥à¸¹à¸à¸„à¹‰à¸²à¹„à¸«à¸™à¸¢à¸­à¸”à¹€à¸¢à¸­à¸°à¸ªà¸¸à¸”" - à¸”à¸¹à¸¥à¸¹à¸à¸„à¹‰à¸²à¸¢à¸­à¸”à¹€à¸¢à¸­à¸°à¸ªà¸¸à¸”\n';
  reply += 'â€¢ "à¸¢à¸­à¸” invoice à¹à¸•à¹ˆà¸¥à¸°à¹€à¸”à¸·à¸­à¸™" - à¸”à¸¹à¸ªà¸–à¸´à¸•à¸´à¸£à¸²à¸¢à¹€à¸”à¸·à¸­à¸™\n';
  reply += 'â€¢ "à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” 6 à¹€à¸”à¸·à¸­à¸™" - à¸”à¸¹à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µ';
  
  return { json: { reply: reply } };
}

// ============================================
// 6. INVOICE DETAIL FORMATTER
// ============================================
function formatInvoiceDetailResponse() {
  const items = $input.all();
  
  // à¹„à¸¡à¹ˆà¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  if (!items || items.length === 0 || !items[0].json || Object.keys(items[0].json).length === 0) {
    return {
      json: {
        reply: "à¸‚à¸­à¸­à¸ à¸±à¸¢à¸„à¸£à¸±à¸š à¹„à¸¡à¹ˆà¸à¸š Invoice à¸™à¸µà¹‰ ğŸ˜”\n\n" +
               "ğŸ’¡ à¸¥à¸­à¸‡à¸„à¸³à¸–à¸²à¸¡à¸­à¸·à¹ˆà¸™:\n" +
               "  â€¢ \"IV0303304\" - à¸¥à¸­à¸‡ invoice à¸­à¸·à¹ˆà¸™\n" +
               "  â€¢ \"à¸à¸²à¸£à¹Œà¹€à¸”à¸µà¸¢à¸™à¸­à¸´à¸™à¸”à¸±à¸ªà¸—à¸£à¸µà¸ªà¹Œ invoice\" - à¸”à¸¹ invoice à¸‚à¸­à¸‡à¸¥à¸¹à¸à¸„à¹‰à¸²\n" +
               "  â€¢ \"à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” 6 à¹€à¸”à¸·à¸­à¸™\"\n" +
               "  â€¢ \"à¸¨à¸¹à¸™à¸¢à¹Œà¹„à¸«à¸™à¸¢à¸­à¸”à¸‚à¸²à¸¢à¹€à¸¢à¸­à¸°à¸ªà¸¸à¸”\""
      }
    };
  }
  
  // à¸¡à¸µà¸‚à¹‰à¸­à¸¡à¸¹à¸¥
  const invoice = items[0].json;
  const lines = items.map(item => item.json); // à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸²
  
  let reply = `ğŸ“„ à¸£à¸²à¸¢à¸¥à¸°à¹€à¸­à¸µà¸¢à¸” Invoice: ${invoice.inv_no}\n\n`;
  reply += `ğŸ‘¤ à¸¥à¸¹à¸à¸„à¹‰à¸²: ${invoice.customer_name} (${invoice.customer_no})\n`;
  reply += `ğŸ¢ à¸¨à¸¹à¸™à¸¢à¹Œ: ${invoice.department_name} (${invoice.department})\n`;
  reply += `ğŸ“… à¸§à¸±à¸™à¸—à¸µà¹ˆ: ${invoice.inv_date}\n`;
  reply += `ğŸ’° à¸¢à¸­à¸”à¸£à¸§à¸¡: ${parseFloat(invoice.total_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} à¸šà¸²à¸—\n\n`;
  reply += `ğŸ“¦ à¸£à¸²à¸¢à¸à¸²à¸£à¸ªà¸´à¸™à¸„à¹‰à¸² (${lines.length} à¸£à¸²à¸¢à¸à¸²à¸£):\n`;
  
  lines.forEach((line, index) => {
    reply += `${index + 1}. ${line.item_no} - ${line.item_description}\n`;
    reply += `   à¸ˆà¸³à¸™à¸§à¸™ ${line.quantity} x ${parseFloat(line.unit_price).toLocaleString('th-TH', {minimumFractionDigits: 2})} = ${parseFloat(line.line_amount).toLocaleString('th-TH', {minimumFractionDigits: 2})} à¸šà¸²à¸—\n`;
  });
  
  reply += '\nâ”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”\n';
  reply += 'ğŸ’¡ à¸•à¹‰à¸­à¸‡à¸à¸²à¸£à¸”à¸¹à¸‚à¹‰à¸­à¸¡à¸¹à¸¥à¹€à¸à¸´à¹ˆà¸¡à¹€à¸•à¸´à¸¡?\n';
  reply += `â€¢ "${invoice.customer_name} à¸¡à¸µ invoice à¸­à¸°à¹„à¸£à¸šà¹‰à¸²à¸‡" - à¸”à¸¹ invoice à¸­à¸·à¹ˆà¸™à¹†\n`;
  reply += `â€¢ "à¸ªà¸´à¸™à¸„à¹‰à¸² ${lines[0].item_no} à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸”à¹„à¸«à¸¡" - à¸”à¸¹à¸ªà¸´à¸™à¸„à¹‰à¸²à¸™à¸µà¹‰\n`;
  reply += `â€¢ "${invoice.department_name} à¸¢à¸­à¸”à¸‚à¸²à¸¢à¹€à¸—à¹ˆà¸²à¹„à¸«à¸£à¹ˆ" - à¸”à¸¹à¸¢à¸­à¸”à¸‚à¸²à¸¢à¸¨à¸¹à¸™à¸¢à¹Œ\n`;
  reply += 'â€¢ "à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µà¸—à¸µà¹ˆà¸ªà¸¸à¸” 6 à¹€à¸”à¸·à¸­à¸™" - à¸”à¸¹à¸ªà¸´à¸™à¸„à¹‰à¸²à¸‚à¸²à¸¢à¸”à¸µ';
  
  return { json: { reply: reply } };
}

// ============================================
// à¹€à¸¥à¸·à¸­à¸à¹ƒà¸Šà¹‰ function à¸—à¸µà¹ˆà¹€à¸«à¸¡à¸²à¸°à¸ªà¸¡
// ============================================
// à¹ƒà¸Šà¹‰à¸•à¸²à¸¡ action à¸—à¸µà¹ˆà¹„à¸”à¹‰à¸ˆà¸²à¸ parser

// à¸ªà¸³à¸«à¸£à¸±à¸š Top Center:
return formatTopCenterResponse();

// à¸ªà¸³à¸«à¸£à¸±à¸š Top Items:
// return formatTopItemsResponse();

// à¸ªà¸³à¸«à¸£à¸±à¸š Monthly Sales:
// return formatMonthlySalesResponse();

// à¸ªà¸³à¸«à¸£à¸±à¸š Product Group Sales:
// return formatProductGroupSalesResponse();

// à¸ªà¸³à¸«à¸£à¸±à¸š Customer Invoices:
// return formatCustomerInvoicesResponse();

// à¸ªà¸³à¸«à¸£à¸±à¸š Invoice Detail:
// return formatInvoiceDetailResponse();
