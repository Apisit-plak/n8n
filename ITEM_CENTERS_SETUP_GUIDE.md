# ЁЯФз р╕Др╕╣р╣Ир╕бр╕╖р╕нр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З Item Centers (р╕кр╕┤р╕Щр╕Др╣Йр╕▓ XXX р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Ър╣Йр╕▓р╕З)

## ЁЯУЛ р╕ар╕▓р╕Юр╕гр╕зр╕б

Feature р╕Щр╕╡р╣Йр╣Гр╕Кр╣Йр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Хр╕нр╕Ър╕Др╕│р╕Цр╕▓р╕бр╣Бр╕Ър╕Ъ: **"р╕кр╕┤р╕Щр╕Др╣Йр╕▓ MC-1002 р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Ър╣Йр╕▓р╕З"**

р╕гр╕░р╕Ър╕Ър╕Ир╕░р╣Бр╕кр╕Фр╕Зр╕гр╕▓р╕вр╕Бр╕▓р╕гр╕ир╕╣р╕Щр╕вр╣М/р╕лр╕Щр╣Ир╕зр╕вр╕Зр╕▓р╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Фр╕Чр╕╡р╣Ир╕Вр╕▓р╕вр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕╡р╣Ир╕гр╕░р╕Ър╕╕ р╕Юр╕гр╣Йр╕нр╕бр╕вр╕нр╕Фр╕Вр╕▓р╕в, р╕Ир╕│р╕Щр╕зр╕Щ, р╣Бр╕ер╕░р╕кр╕Цр╕┤р╕Хр╕┤р╕Хр╣Ир╕▓р╕Зр╣Ж

---

## ЁЯОп р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕Зр╕Др╕│р╕Цр╕▓р╕бр╕Чр╕╡р╣Ир╕гр╕нр╕Зр╕гр╕▒р╕Ъ:

### р╣Бр╕Ър╕Ър╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕р╕Ир╕│р╕Щр╕зр╕Щ (р╣Бр╕кр╕Фр╕З 10 р╕ир╕╣р╕Щр╕вр╣М):
1. `р╕кр╕┤р╕Щр╕Др╣Йр╕▓ MC-1002 р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Ър╣Йр╕▓р╕З`
2. `MC-AP-1001 р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕лр╕Щр╣Ир╕зр╕вр╣Др╕лр╕Щ`
3. `product MC-1002 р╕бр╕╡р╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Вр╕▓р╕вр╕Ър╣Йр╕▓р╕З`

### р╣Бр╕Ър╕Ър╕гр╕░р╕Ър╕╕р╕Ир╕│р╕Щр╕зр╕Щ:
4. `р╕кр╕┤р╕Щр╕Др╣Йр╕▓ MC-1002 р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Ър╣Йр╕▓р╕З TOP 5` (р╣Бр╕кр╕Фр╕З 5 р╕ир╕╣р╕Щр╕вр╣М)
5. `MC-AP-1001 р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕лр╕Щр╣Ир╕зр╕вр╣Др╕лр╕Щ 20 р╕ир╕╣р╕Щр╕вр╣М` (р╣Бр╕кр╕Фр╕З 20 р╕ир╕╣р╕Щр╕вр╣М)
6. `product MC-1002 р╣Бр╕кр╕Фр╕З 15` (р╣Бр╕кр╕Фр╕З 15 р╕ир╕╣р╕Щр╕вр╣М)
7. `MC-AP-1001 р╕Вр╕▓р╕вр╕Чр╕╡р╣Ир╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щ р╕Ир╕│р╕Щр╕зр╕Щ 20` (р╣Бр╕кр╕Фр╕З 20 р╕ир╕╣р╕Щр╕вр╣М)
8. `product MC-1002 20 р╕Хр╕▒р╕з` (р╣Бр╕кр╕Фр╕З 20 р╕ир╕╣р╕Щр╕вр╣М)
9. `р╕кр╕┤р╕Щр╕Др╣Йр╕▓ XX-YY-123 р╕Вр╕▓р╕вр╣Др╕Фр╣Й SBU р╣Др╕лр╕Щр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф` (р╣Бр╕кр╕Фр╕Зр╕Чр╕╕р╕Бр╕ир╕╣р╕Щр╕вр╣М)

### р╕Юр╕гр╣Йр╕нр╕б Time Period:
10. `MC-1002 р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕Чр╕╡р╣Ир╣Др╕лр╕Щр╕Ър╣Йр╕▓р╕З 6 р╣Ар╕Фр╕╖р╕нр╕Щ` (10 р╕ир╕╣р╕Щр╕вр╣М р╕Кр╣Ир╕зр╕З 6 р╣Ар╕Фр╕╖р╕нр╕Щ)
11. `MC-AP-1001 р╕Вр╕▓р╕вр╕Чр╕╡р╣Ир╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Ыр╕╡р╕Щр╕╡р╣Й TOP 5` (5 р╕ир╕╣р╕Щр╕вр╣М р╕Ыр╕╡р╕Щр╕╡р╣Й)
12. `MC-AP-1001 р╕Вр╕▓р╕вр╕Чр╕╡р╣Ир╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Ыр╕╡р╕Щр╕╡р╣Й р╕Ир╕│р╕Щр╕зр╕Щ 20` (20 р╕ир╕╣р╕Щр╕вр╣М р╕Ыр╕╡р╕Щр╕╡р╣Й)
13. `product MC-1002 р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕Чр╕╡р╣Ир╣Др╕лр╕Щ 6 р╣Ар╕Фр╕╖р╕нр╕Щ 20 р╕Хр╕▒р╕з` (20 р╕ир╕╣р╕Щр╕вр╣М р╕Кр╣Ир╕зр╕З 6 р╣Ар╕Фр╕╖р╕нр╕Щ)

---

## тЪЩя╕П р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕Зр╣Гр╕Щ n8n

### 1я╕ПтГг р╕нр╕▒р╕Юр╣Ар╕Фр╕Ч Parser (Code Node)

**р╣Др╕Яр╕ер╣М:** `n8n_code_parser.js`

тЬЕ **р╣Ар╕кр╕гр╣Зр╕Ир╣Бр╕ер╣Йр╕з!** Parser р╣Др╕Фр╣Йр╕Цр╕╣р╕Бр╕нр╕▒р╕Юр╣Ар╕Фр╕Чр╣Бр╕ер╣Йр╕зр╣Ар╕Юр╕╖р╣Ир╕нр╕гр╕нр╕Зр╕гр╕▒р╕Ъ `item_centers` action

**р╕кр╕┤р╣Ир╕Зр╕Чр╕╡р╣И Parser р╕Ир╕░р╕Чр╕│:**
- р╕Ир╕▒р╕Ър╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓ (р╣Ар╕Кр╣Ир╕Щ MC-1002, MC-AP-1001)
- р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ keyword р╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕Зр╕Бр╕▒р╕Ър╕ир╕╣р╕Щр╕вр╣М/р╕лр╕Щр╣Ир╕зр╕вр╕Зр╕▓р╕Щ
- Extract time period (р╕Цр╣Йр╕▓р╕бр╕╡)
- Extract limit (р╣Ар╕Кр╣Ир╕Щ TOP 5, 20 р╕ир╕╣р╕Щр╕вр╣М, р╣Бр╕кр╕Фр╕З 15) - default: 10
- Return: `{ action: 'item_centers', item_no: 'MC-1002', time_period: {...}, limit: 10 }`

---

### 2я╕ПтГг р╣Ар╕Юр╕┤р╣Ир╕б Route р╣Гр╕Щ Switch Node

1. р╣Ар╕Ыр╕┤р╕Ф **Switch** node р╣Гр╕Щ n8n workflow
2. р╕Др╕ер╕┤р╕Б **Add Routing Rule**
3. р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ route р╣Гр╕лр╕бр╣И:

```
Output: 7 (р╕лр╕гр╕╖р╕нр╕лр╕бр╕▓р╕вр╣Ар╕ер╕Вр╕Цр╕▒р╕Фр╣Др╕Ы)
Mode: Rules
Rules:
  - Condition: {{ $json.action === "item_centers" }}
```

4. р╕Др╕ер╕┤р╕Б **Save**

---

### 3я╕ПтГг р╣Ар╕Юр╕┤р╣Ир╕б Execute SQL Node

1. р╣Ар╕Юр╕┤р╣Ир╕б **MySQL** node (Execute SQL)
2. р╣Ар╕Кр╕╖р╣Ир╕нр╕б output 7 р╕Ир╕▓р╕Б Switch node р╣Ар╕Вр╣Йр╕▓р╕Бр╕▒р╕Ъ MySQL node р╕Щр╕╡р╣Й
3. р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓:
   - **Credential:** `Datawarehouse_test`
   - **Operation:** `Execute Query`
   - **Query:** р╕Др╕▒р╕Фр╕ер╕нр╕Бр╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣М `SQL_ITEM_CENTERS_QUERY.md`

**SQL Query:**

```sql
SELECT
    h.inv_department AS department,
    h.inv_department_name AS department_name,
    COUNT(DISTINCT h.inv_no) AS invoice_count,
    SUM(l.inv_line_quantity) AS total_quantity,
    SUM(l.inv_line_amount) AS total_amount,
    SUM(l.inv_line_amount_vat) AS total_vat,
    SUM(l.inv_line_amount + l.inv_line_amount_vat) AS net_amount,
    AVG(l.inv_line_amount + l.inv_line_amount_vat) AS avg_amount,
    MIN(h.inv_posting_date) AS first_invoice_date,
    MAX(h.inv_posting_date) AS last_invoice_date,
    l.inv_line_description AS item_description,
    l.inv_line_item_no AS item_no,
    GROUP_CONCAT(DISTINCT h.inv_no ORDER BY h.inv_posting_date DESC SEPARATOR ', ' LIMIT 5) AS sample_invoices
FROM data_warehouse.service_posted_invoice_line l
LEFT JOIN data_warehouse.service_posted_invoice_header h
    ON h.inv_no = l.inv_line_inv_no
WHERE 1=1
{{ $json.item_no ? `
    AND l.inv_line_item_no = '${$json.item_no}'
` : '' }}
{{ $json.time_period && $json.time_period.period === 'this_year' ? `
    AND YEAR(h.inv_posting_date) = YEAR(CURDATE())
` : '' }}
{{ $json.time_period && $json.time_period.period === 'last_year' ? `
    AND YEAR(h.inv_posting_date) = YEAR(CURDATE()) - 1
` : '' }}
{{ $json.time_period && $json.time_period.period === 'this_month' ? `
    AND YEAR(h.inv_posting_date) = YEAR(CURDATE())
    AND MONTH(h.inv_posting_date) = MONTH(CURDATE())
` : '' }}
{{ $json.time_period && $json.time_period.period === 'last_month' ? `
    AND YEAR(h.inv_posting_date) = YEAR(CURDATE())
    AND MONTH(h.inv_posting_date) = MONTH(CURDATE()) - 1
` : '' }}
{{ $json.time_period && $json.time_period.period === 'month' && $json.time_period.value ? `
    AND h.inv_posting_date >= DATE_SUB(CURDATE(), INTERVAL ${$json.time_period.value} MONTH)
` : '' }}
{{ $json.time_period && $json.time_period.period === 'year' && $json.time_period.value ? `
    AND h.inv_posting_date >= DATE_SUB(CURDATE(), INTERVAL ${$json.time_period.value} YEAR)
` : '' }}
    AND h.inv_department IS NOT NULL
    AND l.inv_line_item_no IS NOT NULL
GROUP BY
    h.inv_department,
    h.inv_department_name,
    l.inv_line_item_no,
    l.inv_line_description
ORDER BY total_amount DESC
LIMIT {{ $json.limit || 10 }}
```

4. р╣Др╕Ыр╕Чр╕╡р╣И **Settings** tab
5. р╣Ар╕Ыр╕┤р╕Ф **Continue on Fail** р╣Бр╕ер╕░ **Always Output Data**
6. р╕Др╕ер╕┤р╕Б **Save**

---

### 4я╕ПтГг р╣Ар╕Юр╕┤р╣Ир╕б Formatter (Code Node)

1. р╣Ар╕Юр╕┤р╣Ир╕б **Code** node р╕лр╕ер╕▒р╕З MySQL node
2. р╣Ар╕Ыр╕ер╕╡р╣Ир╕вр╕Щр╕Кр╕╖р╣Ир╕нр╣Ар╕Ыр╣Зр╕Щ `Format_ItemCenters`
3. р╕Др╕▒р╕Фр╕ер╕нр╕Бр╣Вр╕Др╣Йр╕Фр╕Ир╕▓р╕Бр╣Др╕Яр╕ер╣М `FORMATTER_ITEM_CENTERS.js` р╕зр╕▓р╕Зр╣Гр╕Щ Code editor
4. р╕Др╕ер╕┤р╕Б **Save**

---

### 5я╕ПтГг р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ Respond to Webhook

1. р╣Ар╕Кр╕╖р╣Ир╕нр╕б output р╕Ир╕▓р╕Б `Format_ItemCenters` node р╣Ар╕Вр╣Йр╕▓р╕Бр╕▒р╕Ъ **Respond to Webhook** node
2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ Respond to Webhook р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Ар╕Ыр╣Зр╕Щ:
   - **Respond With:** `Using Fields Below`
   - **Response Body:** `{{ $json.reply }}`
   - **Response Code:** `200`

---

## ЁЯзк р╕Чр╕Фр╕кр╕нр╕Ъ Workflow

### р╕зр╕┤р╕Шр╕╡р╕Чр╕Фр╕кр╕нр╕Ъ:

1. р╕Др╕ер╕┤р╕Б **Execute Workflow** р╣Гр╕Щ n8n
2. р╕кр╣Ир╕Зр╕Др╕│р╕Цр╕▓р╕бр╕Ир╕▓р╕Б `index.html` р╕лр╕гр╕╖р╕н API client:

```bash
curl -X POST http://localhost:3000/webhook \
  -H "Content-Type: application/json" \
  -d '{"text":"р╕кр╕┤р╕Щр╕Др╣Йр╕▓ MC-1002 р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Ър╣Йр╕▓р╕З","session_id":"test_001"}'
```

### р╕Ьр╕ер╕ер╕▒р╕Юр╕Шр╣Мр╕Чр╕╡р╣Ир╕Др╕▓р╕Фр╕лр╕зр╕▒р╕З:

```
ЁЯЫНя╕П р╕кр╕┤р╕Щр╕Др╣Йр╕▓: MC-1002
ЁЯУЭ р╕Др╕│р╕нр╕Шр╕┤р╕Ър╕▓р╕вр╕кр╕┤р╕Щр╕Др╣Йр╕▓

тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ

ЁЯУН р╕ир╕╣р╕Щр╕вр╣М/р╕лр╕Щр╣Ир╕зр╕вр╕Зр╕▓р╕Щр╕Чр╕╡р╣Ир╕Вр╕▓р╕вр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Щр╕╡р╣Й:

1. **р╕ир╕╣р╕Щр╕вр╣Мр╕Бр╕гр╕╕р╕Зр╣Ар╕Чр╕Ю** (100)
   ЁЯТ░ р╕вр╕нр╕Фр╕гр╕зр╕б: 500,000.00 р╕Ър╕▓р╕Ч
   ЁЯУж р╕Ир╕│р╕Щр╕зр╕Щ: 150 р╕Кр╕┤р╣Йр╕Щ
   ЁЯУД Invoice: 25 р╣Гр╕Ъ
   ЁЯУК р╣Ар╕Йр╕ер╕╡р╣Ир╕в: 20,000.00 р╕Ър╕▓р╕Ч/р╣Гр╕Ъ
   ЁЯУЕ р╕Кр╣Ир╕зр╕Зр╣Ар╕зр╕ер╕▓: 2025-01-01 р╕Цр╕╢р╕З 2026-01-20

2. **р╕ир╕╣р╕Щр╕вр╣Мр╣Ар╕Кр╕╡р╕вр╕Зр╣Гр╕лр╕бр╣И** (200)
   ЁЯТ░ р╕вр╕нр╕Фр╕гр╕зр╕б: 300,000.00 р╕Ър╕▓р╕Ч
   ...

тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ

ЁЯУК р╕кр╕гр╕╕р╕Ыр╕гр╕зр╕б:
   ЁЯПв р╕Ир╕│р╕Щр╕зр╕Щр╕ир╕╣р╕Щр╕вр╣М: 5 р╕ир╕╣р╕Щр╕вр╣М
   ЁЯТ░ р╕вр╕нр╕Фр╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф: 1,500,000.00 р╕Ър╕▓р╕Ч
   ЁЯУж р╕Ир╕│р╕Щр╕зр╕Щр╕гр╕зр╕б: 500 р╕Кр╕┤р╣Йр╕Щ
   ЁЯУД Invoice р╕гр╕зр╕б: 75 р╣Гр╕Ъ

ЁЯУЛ р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З Invoice (р╕Ир╕▓р╕Б р╕ир╕╣р╕Щр╕вр╣Мр╕Бр╕гр╕╕р╕Зр╣Ар╕Чр╕Ю):
   тАв IV0303304
   тАв IV0303305
   тАв IV0303306

тФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБтФБ
ЁЯТб р╕Хр╣Йр╕нр╕Зр╕Бр╕▓р╕гр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Юр╕┤р╣Ир╕бр╣Ар╕Хр╕┤р╕б?
  тАв "р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Вр╕▓р╕вр╕Фр╕╡р╕Чр╕╡р╣Ир╕кр╕╕р╕Ф 6 р╣Ар╕Фр╕╖р╕нр╕Щ" - р╕Фр╕╣р╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Вр╕▓р╕вр╕Фр╕╡р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
  тАв "р╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕вр╕нр╕Фр╕Вр╕▓р╕вр╣Ар╕вр╕нр╕░р╕кр╕╕р╕Ф" - р╕Фр╕╣р╕ир╕╣р╕Щр╕вр╣Мр╕Чр╕╡р╣Ир╕Вр╕▓р╕вр╕Фр╕╡р╕Чр╕╡р╣Ир╕кр╕╕р╕Ф
  тАв "TOP 10 р╕кр╕┤р╕Щр╕Др╣Йр╕▓ 3 р╣Ар╕Фр╕╖р╕нр╕Щ" - р╕Фр╕╣ TOP р╕кр╕┤р╕Щр╕Др╣Йр╕▓
  тАв "MC-1002 р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щ 6 р╣Ар╕Фр╕╖р╕нр╕Щ" - р╕Фр╕╣р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Кр╣Ир╕зр╕З 6 р╣Ар╕Фр╕╖р╕нр╕Щ
```

---

## тЪая╕П р╕лр╕бр╕▓р╕вр╣Ар╕лр╕Хр╕╕р╕кр╕│р╕Др╕▒р╕Н:

### 1. Item Number Required
- р╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╣Гр╕Щр╕Др╕│р╕Цр╕▓р╕б (р╣Ар╕Кр╣Ир╕Щ MC-1002, MC-AP-1001)
- р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕бр╕╡р╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓ parser р╕Ир╕░р╕Ир╕▒р╕Ър╣Ар╕Ыр╣Зр╕Щ action р╕нр╕╖р╣Ир╕Щ

### 2. No Data Handling
- р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕┤р╕Щр╕Др╣Йр╕▓ formatter р╕Ир╕░р╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕Др╕зр╕▓р╕б "р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Щр╕╡р╣Й"
- р╕Хр╣Йр╕нр╕Зр╣Ар╕Ыр╕┤р╕Ф **Continue on Fail** р╣Бр╕ер╕░ **Always Output Data** р╣Гр╕Щ Execute SQL node

### 3. Department from Header
- р╣Гр╕Кр╣Й `h.inv_department` (р╕Ир╕▓р╕Б header) р╣Ар╕Юр╕╖р╣Ир╕нр╕Фр╕╣р╕зр╣Ир╕▓**р╕ир╕╣р╕Щр╕вр╣М/р╕лр╕Щр╣Ир╕зр╕вр╕Зр╕▓р╕Щр╣Др╕лр╕Щр╕Вр╕▓р╕вр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Щр╕╡р╣Й**
- р╣Др╕бр╣Ир╣Гр╕Кр╣Й `l.inv_line_department` (р╕ир╕╣р╕Щр╕вр╣Мр╕Чр╕╡р╣Ир╣Ар╕Бр╣Зр╕Ър╕кр╕┤р╕Щр╕Др╣Йр╕▓)

### 4. Time Period Support
- р╕гр╕нр╕Зр╕гр╕▒р╕Ъ time period (р╣Ар╕Кр╣Ир╕Щ "6 р╣Ар╕Фр╕╖р╕нр╕Щ", "р╕Ыр╕╡р╕Щр╕╡р╣Й")
- р╕Цр╣Йр╕▓р╣Др╕бр╣Ир╕гр╕░р╕Ър╕╕р╕Ир╕░р╣Бр╕кр╕Фр╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф

### 5. Limit Support
- **Default:** р╣Бр╕кр╕Фр╕З 10 р╕ир╕╣р╕Щр╕вр╣М
- **р╕гр╕нр╕Зр╕гр╕▒р╕Ър╕лр╕ер╕▓р╕вр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ:**
  - `TOP 5` тЖТ р╣Бр╕кр╕Фр╕З 5 р╕ир╕╣р╕Щр╕вр╣М
  - `20 р╕ир╕╣р╕Щр╕вр╣М` тЖТ р╣Бр╕кр╕Фр╕З 20 р╕ир╕╣р╕Щр╕вр╣М
  - `р╕ир╕╣р╕Щр╕вр╣М 15` тЖТ р╣Бр╕кр╕Фр╕З 15 р╕ир╕╣р╕Щр╕вр╣М
  - `р╕Ир╕│р╕Щр╕зр╕Щ 20` тЖТ р╣Бр╕кр╕Фр╕З 20 р╕ир╕╣р╕Щр╕вр╣М
  - `20 р╕Хр╕▒р╕з` тЖТ р╣Бр╕кр╕Фр╕З 20 р╕ир╕╣р╕Щр╕вр╣М
  - `р╕Хр╕▒р╕з 20` тЖТ р╣Бр╕кр╕Фр╕З 20 р╕ир╕╣р╕Щр╕вр╣М
  - `р╣Бр╕кр╕Фр╕З 15` тЖТ р╣Бр╕кр╕Фр╕З 15 р╕ир╕╣р╕Щр╕вр╣М
  - `р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф` тЖТ р╣Бр╕кр╕Фр╕З 100 р╕ир╕╣р╕Щр╕вр╣М

---

## ЁЯУК р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Бр╕кр╕Фр╕З:

1. **р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕┤р╕Щр╕Др╣Йр╕▓:**
   - р╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓
   - р╕Др╕│р╕нр╕Шр╕┤р╕Ър╕▓р╕в

2. **р╕гр╕▓р╕вр╕Бр╕▓р╕гр╕ир╕╣р╕Щр╕вр╣М/р╕лр╕Щр╣Ир╕зр╕вр╕Зр╕▓р╕Щ:**
   - р╕Кр╕╖р╣Ир╕нр╕ир╕╣р╕Щр╕вр╣М/р╕лр╕Щр╣Ир╕зр╕вр╕Зр╕▓р╕Щ
   - р╕гр╕лр╕▒р╕кр╕ир╕╣р╕Щр╕вр╣М
   - р╕вр╕нр╕Фр╕гр╕зр╕бр╕кр╕╕р╕Чр╕Шр╕┤
   - р╕Ир╕│р╕Щр╕зр╕Щр╕кр╕┤р╕Щр╕Др╣Йр╕▓
   - р╕Ир╕│р╕Щр╕зр╕Щ Invoice
   - р╕вр╕нр╕Фр╣Ар╕Йр╕ер╕╡р╣Ир╕в
   - р╕Кр╣Ир╕зр╕Зр╣Ар╕зр╕ер╕▓ (р╕зр╕▒р╕Щр╕Чр╕╡р╣Ир╣Бр╕гр╕Бр╣Бр╕ер╕░р╕ер╣Ир╕▓р╕кр╕╕р╕Ф)

3. **р╕кр╕гр╕╕р╕Ыр╕гр╕зр╕б:**
   - р╕Ир╕│р╕Щр╕зр╕Щр╕ир╕╣р╕Щр╕вр╣Мр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
   - р╕вр╕нр╕Фр╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
   - р╕Ир╕│р╕Щр╕зр╕Щр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф
   - Invoice р╕гр╕зр╕бр╕Чр╕▒р╣Йр╕Зр╕лр╕бр╕Ф

4. **р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З Invoice:**
   - Invoice numbers (р╕Ир╕▓р╕Бр╕ир╕╣р╕Щр╕вр╣Мр╕Чр╕╡р╣Ир╕Вр╕▓р╕вр╣Ар╕вр╕нр╕░р╕кр╕╕р╕Ф)

5. **Contextual Suggestions:**
   - р╕Др╕│р╕Цр╕▓р╕бр╣Бр╕Щр╕░р╕Щр╕│р╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕З

---

## ЁЯФз Troubleshooting:

### р╕Ыр╕▒р╕Нр╕лр╕▓: р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕кр╕Фр╕Зр╕нр╕нр╕Бр╕бр╕▓
**р╣Бр╕Бр╣Йр╣Др╕В:**
1. р╣Ар╕Кр╣Зр╕Д Execute SQL node тЖТ Settings тЖТ р╣Ар╕Ыр╕┤р╕Ф **Continue on Fail** р╣Бр╕ер╕░ **Always Output Data**
2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ `item_no` р╕Цр╕╣р╕Бр╕кр╣Ир╕Зр╕бр╕▓р╕Ир╕▓р╕Б parser р╕лр╕гр╕╖р╕нр╣Др╕бр╣И (р╕Фр╕╣р╕Чр╕╡р╣И output р╕Вр╕нр╕З parser node)
3. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И (р╕ер╕нр╕Зр╣Ар╕Кр╣Зр╕Др╣Гр╕Щ database)

### р╕Ыр╕▒р╕Нр╕лр╕▓: Parser р╕Ир╕▒р╕Ър╣Ар╕Ыр╣Зр╕Щ action р╕нр╕╖р╣Ир╕Щ
**р╣Бр╕Бр╣Йр╣Др╕В:**
1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Др╕│р╕Цр╕▓р╕бр╕зр╣Ир╕▓р╕бр╕╡р╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И (р╕Хр╣Йр╕нр╕Зр╕бр╕╡р╕гр╕лр╕▒р╕кр╕кр╕┤р╕Щр╕Др╣Йр╕▓ + center question keyword)
2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ `n8n_code_parser.js` р╣Др╕Фр╣Йр╕Цр╕╣р╕Бр╕нр╕▒р╕Юр╣Ар╕Фр╕Чр╣Бр╕ер╣Йр╕зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
3. р╕Фр╕╣ console.log р╣Гр╕Щ parser node р╣Ар╕Юр╕╖р╣Ир╕нр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ

### р╕Ыр╕▒р╕Нр╕лр╕▓: р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Др╕бр╣Ир╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
**р╣Бр╕Бр╣Йр╣Др╕В:**
1. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ SQL query р╕зр╣Ир╕▓ WHERE conditions р╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
2. р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓ time period р╕Цр╕╣р╕Б extract р╕бр╕▓р╕нр╕вр╣Ир╕▓р╕Зр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕лр╕гр╕╖р╕нр╣Др╕бр╣И
3. р╕Чр╕Фр╕кр╕нр╕Ъ SQL query р╣Вр╕Фр╕вр╕Хр╕гр╕Зр╣Гр╕Щ database

---

## ЁЯУЪ р╣Др╕Яр╕ер╣Мр╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕З:

1. **Parser:** `n8n_code_parser.js` (lines 333-386)
2. **SQL Query:** `SQL_ITEM_CENTERS_QUERY.md`
3. **Formatter:** `FORMATTER_ITEM_CENTERS.js`
4. **Setup Guide:** `ITEM_CENTERS_SETUP_GUIDE.md` (р╣Др╕Яр╕ер╣Мр╕Щр╕╡р╣Й)

---

## тЬЕ Checklist р╕Бр╕▓р╕гр╕Хр╕┤р╕Фр╕Хр╕▒р╣Йр╕З:

- [ ] р╕нр╕▒р╕Юр╣Ар╕Фр╕Ч parser (`n8n_code_parser.js`)
- [ ] р╣Ар╕Юр╕┤р╣Ир╕б route р╣Гр╕Щ Switch node (output 7: `item_centers`)
- [ ] р╣Ар╕Юр╕┤р╣Ир╕б Execute SQL node р╕Юр╕гр╣Йр╕нр╕б SQL query
- [ ] р╣Ар╕Ыр╕┤р╕Ф **Continue on Fail** р╣Бр╕ер╕░ **Always Output Data** р╣Гр╕Щ Execute SQL node
- [ ] р╣Ар╕Юр╕┤р╣Ир╕б Code node (formatter) р╕Юр╕гр╣Йр╕нр╕бр╣Вр╕Др╣Йр╕Фр╕Ир╕▓р╕Б `FORMATTER_ITEM_CENTERS.js`
- [ ] р╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ Respond to Webhook node
- [ ] р╕Чр╕Фр╕кр╕нр╕Ър╕Фр╣Йр╕зр╕вр╕Др╕│р╕Цр╕▓р╕б "р╕кр╕┤р╕Щр╕Др╣Йр╕▓ MC-1002 р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Ър╣Йр╕▓р╕З"
- [ ] р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕зр╣Ир╕▓р╣Бр╕кр╕Фр╕Зр╕Ьр╕ер╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З
- [ ] р╕Чр╕Фр╕кр╕нр╕Ър╕Бр╕гр╕Ур╕╡р╣Др╕бр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕е (no data)
- [ ] р╕Чр╕Фр╕кр╕нр╕Ър╕Фр╣Йр╕зр╕в time period (р╣Ар╕Кр╣Ир╕Щ "6 р╣Ар╕Фр╕╖р╕нр╕Щ", "р╕Ыр╕╡р╕Щр╕╡р╣Й")

---

## ЁЯОЙ р╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щ!

р╕Хр╕нр╕Щр╕Щр╕╡р╣Йр╕гр╕░р╕Ър╕Ър╕Юр╕гр╣Йр╕нр╕бр╕гр╕нр╕Зр╕гр╕▒р╕Ър╕Др╕│р╕Цр╕▓р╕б **"р╕кр╕┤р╕Щр╕Др╣Йр╕▓ XXX р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Ър╣Йр╕▓р╕З"** р╣Бр╕ер╣Йр╕з!

р╕ер╕нр╕Зр╕Цр╕▓р╕бр╕Др╕│р╕Цр╕▓р╕бр╕Хр╣Ир╕▓р╕Зр╣Ж р╣Ар╕Юр╕╖р╣Ир╕нр╕Чр╕Фр╕кр╕нр╕Ъ:
- `р╕кр╕┤р╕Щр╕Др╣Йр╕▓ MC-1002 р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Ър╣Йр╕▓р╕З`
- `MC-AP-1001 р╕Вр╕▓р╕вр╣Др╕Фр╣Йр╕лр╕Щр╣Ир╕зр╕вр╣Др╕лр╕Щ 6 р╣Ар╕Фр╕╖р╕нр╕Щ`
- `product MC-1002 р╕бр╕╡р╕ир╕╣р╕Щр╕вр╣Мр╣Др╕лр╕Щр╕Вр╕▓р╕вр╕Ър╣Йр╕▓р╕Зр╕Ыр╕╡р╕Щр╕╡р╣Й`
